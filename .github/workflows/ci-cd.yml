# Nome do seu workflow
name: CI/CD 

on:
  push:
    branches: [ master ]

jobs:
  build-and-push:
    runs-on: ubuntu-latest

    steps:
      # 1Ô∏è‚É£ Checkout do c√≥digo
      - name: Checkout do c√≥digo
        uses: actions/checkout@v3

      # 2Ô∏è‚É£ Configurar Docker Buildx
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      # 3Ô∏è‚É£ Login no Docker Hub
      - name: Login no Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_HUB_USERNAME }}
          password: ${{ secrets.DOCKER_HUB_ACCESS_TOKEN }}

      # 4Ô∏è‚É£ Verificar login Docker
      - name: Verificar Docker Login
        run: docker info

      # 5Ô∏è‚É£ Build Backend - passo 1
      - name: Build Backend - Prepara√ß√£o
        run: echo "Preparando build do backend"

      # 6Ô∏è‚É£ Build Backend - passo 2
      - name: Build Backend - Docker
        uses: docker/build-push-action@v4
        with:
          context: ./backend 
          push: true
          tags: jsoesrr/backend:latest

      # 7Ô∏è‚É£ Verificar imagem backend
      - name: Verificar imagem Backend
        run: docker images jsoesrr/backend:latest

      # 8Ô∏è‚É£ Build Frontend - passo 1
      - name: Build Frontend - Prepara√ß√£o
        run: echo "Preparando build do frontend"

      # 9Ô∏è‚É£ Build Frontend - passo 2
      - name: Build Frontend - Docker
        uses: docker/build-push-action@v4
        with:
          context: ./client 
          push: true
          tags: jsoesrr/frontend:latest

      # üîü Verificar imagem frontend
      - name: Verificar imagem Frontend
        run: docker images jsoesrr/frontend:latest


  deploy-to-k3s:
    runs-on: ubuntu-latest
    needs: build-and-push 

    steps:
      # 1Ô∏è‚É£ Conectar √† inst√¢ncia K3s
      - name: Conectar √† inst√¢ncia K3s
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.AWS_HOST }}
          username: ${{ secrets.AWS_USERNAME }}
          key: ${{ secrets.AWS_SSH_KEY }}
          port: 22
          script: |
            echo "Conectado √† inst√¢ncia K3s..."

      # 2Ô∏è‚É£ Reinicializar Backend
      - name: Reinicializar Backend
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.AWS_HOST }}
          username: ${{ secrets.AWS_USERNAME }}
          key: ${{ secrets.AWS_SSH_KEY }}
          port: 22
          script: |
            sudo /usr/local/bin/k3s kubectl rollout restart deployment backend -n app-demo
            echo "Backend reinicializado"

      # 3Ô∏è‚É£ Reinicializar Frontend
      - name: Reinicializar Frontend
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.AWS_HOST }}
          username: ${{ secrets.AWS_USERNAME }}
          key: ${{ secrets.AWS_SSH_KEY }}
          port: 22
          script: |
            sudo /usr/local/bin/k3s kubectl rollout restart deployment frontend -n app-demo
            echo "Frontend reinicializado"

      # 4Ô∏è‚É£ Confirmar Deploy
      - name: Confirmar Deploy
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.AWS_HOST }}
          username: ${{ secrets.AWS_USERNAME }}
          key: ${{ secrets.AWS_SSH_KEY }}
          port: 22
          script: |
            echo "Implanta√ß√£o conclu√≠da com sucesso!"
